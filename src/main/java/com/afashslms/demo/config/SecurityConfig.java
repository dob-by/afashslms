package com.afashslms.demo.config;

import com.afashslms.demo.domain.Role;
import com.afashslms.demo.domain.User;
import com.afashslms.demo.security.CustomOAuth2User;
import com.afashslms.demo.security.CustomUserDetails;
import com.afashslms.demo.service.CustomOAuth2UserService;
import com.afashslms.demo.service.CustomUserDetailsService;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.web.DefaultRedirectStrategy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import com.afashslms.demo.security.CustomAuthenticationFilter;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final CustomUserDetailsService customUserDetailsService;
    private final PasswordEncoder passwordEncoder;
    private final CustomOAuth2UserService customOAuth2UserService;

    @Bean
    public AuthenticationSuccessHandler successHandler() {
        return (request, response, authentication) -> {
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();
            DefaultRedirectStrategy redirectStrategy = new DefaultRedirectStrategy();

            if (auth != null && auth.isAuthenticated()) {
                Object principal = auth.getPrincipal();

                // ‚úÖ OAuth2 Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê
                if (principal instanceof CustomOAuth2User customOAuthUser) {
                    User user = customOAuthUser.getUser();

                    // ‚úÖ userÍ∞Ä nullÏù∏ Í≤ΩÏö∞ ‚Üí ÏµúÏ¥à Î°úÍ∑∏Ïù∏
                    if (user == null) {
                        request.getSession().setAttribute("oauthEmail", customOAuthUser.getEmail());
                        request.getSession().setAttribute("oauthProvider", customOAuthUser.getProvider());
                        redirectStrategy.sendRedirect(request, response, "/admin/profile");
                        return;
                    }

                    // ‚úÖ Role == TEMP ‚Üí ÏµúÏ¥à Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
                    if (user.getRole() == Role.TEMP) {
                        request.getSession().setAttribute("oauthEmail", customOAuthUser.getEmail());
                        request.getSession().setAttribute("oauthProvider", customOAuthUser.getProvider());
                        redirectStrategy.sendRedirect(request, response, "/admin/profile");
                        return;
                    }

                    // ‚úÖ ÌîÑÎ°úÌïÑ ÎØ∏ÏôÑÏÑ±
                    if (!user.isProfileComplete()) {
                        redirectStrategy.sendRedirect(request, response, "/admin/profile");
                        return;
                    }

                    // Î™®Îì† Í¥ÄÎ¶¨ÏûêÎäî Î°úÍ∑∏Ïù∏ ÌõÑ ÌôàÏúºÎ°ú Ïù¥Îèô
                    redirectStrategy.sendRedirect(request, response, "/");
                    return;
                }

                // ‚úÖ ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê (Î°úÏª¨ Î°úÍ∑∏Ïù∏)
                if (principal instanceof CustomUserDetails customUser) {
                    User user = customUser.getUser();
                    if (user.getRole().name().contains("ADMIN")) {
                        redirectStrategy.sendRedirect(request, response, "/admin/mypage");
                        return;
                    }
                }

                // ‚úÖ Í∏∞Î≥∏ ÌïôÏÉù
                redirectStrategy.sendRedirect(request, response, "/home");
            }
        };
    }

    // ‚úÖ Security ÏÑ§Ï†ï
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        AuthenticationManagerBuilder builder = http.getSharedObject(AuthenticationManagerBuilder.class);
        builder.authenticationProvider(authenticationProvider());
        AuthenticationManager authenticationManager = builder.getOrBuild();

        CustomAuthenticationFilter customFilter = new CustomAuthenticationFilter(authenticationManager);
        customFilter.setFilterProcessesUrl("/login");
        customFilter.setUsernameParameter("username");
        customFilter.setPasswordParameter("password");
        customFilter.setRequiresAuthenticationRequestMatcher(new AntPathRequestMatcher("/login", "POST"));

        http
                .csrf(csrf -> csrf.ignoringRequestMatchers("/h2-console/**", "/import/**"))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers(
                                "/users/check-email", "/users/check-userid", "/signup", "/login",
                                "/css/**", "/js/**", "/h2-console/**", "/import/**"
                        ).permitAll()

                        // ‚úÖ TEMPÏùò GET/POST Î™®Îëê ÌóàÏö©ÌïòÎèÑÎ°ù Î∂ÑÎ¶¨
                        .requestMatchers(HttpMethod.GET, "/admin/profile").hasAnyRole("TEMP", "MID_ADMIN", "TOP_ADMIN")
                        .requestMatchers(HttpMethod.POST, "/admin/profile").hasRole("TEMP")

                        // ‚úÖ Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏûêÎèÑ ÌîÑÎ°úÌïÑ ÌéòÏù¥ÏßÄ Ï†ëÍ∑º ÌóàÏö© (Ïòà: ÏäπÏù∏ ÌõÑÎèÑ Îã§Ïãú Î≥º Ïàò ÏûàÍ≤å)
                        .requestMatchers("/admin/profile").hasAnyRole("TEMP", "MID_ADMIN", "TOP_ADMIN")

                        // ‚úÖ TEMPÎäî ÎÇòÎ®∏ÏßÄ Ï†ÑÎ∂Ä Ï†ëÍ∑º Ï∞®Îã®
                        .requestMatchers("/**").not().hasRole("TEMP")

                        // ‚úÖ Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ
                        .requestMatchers("/admin/pending-admins").hasRole("TOP_ADMIN")
                        .requestMatchers("/admin/users/**", "/admin/laptops/**", "/admin/mypage")
                        .hasAnyRole("MID_ADMIN", "TOP_ADMIN")

                        // ‚úÖ ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏö© Í≤ΩÎ°ú
                        .requestMatchers("/mypage/password").authenticated()

                        // ‚úÖ Í∑∏ Ïô∏ ÏöîÏ≤≠ Ïù∏Ï¶ù ÌïÑÏöî
                        .anyRequest().authenticated()
                )
                .addFilterAt(customFilter, UsernamePasswordAuthenticationFilter.class)
                .oauth2Login(oauth2 -> oauth2
                        .loginPage("/login")
                        .userInfoEndpoint(userInfo -> userInfo.userService(customOAuth2UserService))
                        .successHandler(successHandler()) // ‚úÖ Ïù¥Í±∞Îßå ÎÇ®ÍπÄ
                        .failureHandler((request, response, exception) -> {
                            String errorMessage = "OAuth2 Î°úÍ∑∏Ïù∏ Ïã§Ìå®"; // Í∏∞Î≥∏Í∞í

                            if (exception instanceof OAuth2AuthenticationException oAuth2Ex) {
                                String errorCode = oAuth2Ex.getError().getErrorCode();

                                if ("pending_admin".equals(errorCode)) {
                                    errorMessage = "ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ Í¥ÄÎ¶¨ÏûêÏûÖÎãàÎã§. Í¥ÄÎ¶¨Ïûê ÏäπÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.";
                                } else if (oAuth2Ex.getError().getDescription() != null && !oAuth2Ex.getError().getDescription().isBlank()) {
                                    errorMessage = oAuth2Ex.getError().getDescription();
                                }
                            } else {
                                String msg = exception.getMessage();
                                if (msg != null && !msg.isBlank()) {
                                    errorMessage = msg;
                                }
                            }

                            System.out.println("OAuth2 Login Failed: " + errorMessage);
                            response.sendRedirect("/login?errorMessage=" + URLEncoder.encode(errorMessage, StandardCharsets.UTF_8));
                        })
                )
                .exceptionHandling(exception -> exception
                        .accessDeniedHandler(customAccessDeniedHandler()) // üëà Ïó¨Í∏∞Ïóê Îì±Î°ù
                )
                .logout(logout -> logout
                        .logoutUrl("/logout")
                        .logoutSuccessUrl("/login")
                        .invalidateHttpSession(true)
                        .deleteCookies("JSESSIONID")
                )
                .authenticationManager(authenticationManager);

        return http.build();
    }

    // ‚úÖ Ïù∏Ï¶ù Í≥µÍ∏âÏûê ÏÑ§Ï†ï
    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(customUserDetailsService);
        provider.setPasswordEncoder(passwordEncoder);
        return provider;
    }

    // ‚úÖ AuthenticationManager Bean Îì±Î°ù
    @Bean
    public AuthenticationManager authenticationManager(HttpSecurity http) throws Exception {
        return http.getSharedObject(AuthenticationManagerBuilder.class)
                .authenticationProvider(authenticationProvider())
                .build();
    }

    @Bean
    public AccessDeniedHandler customAccessDeniedHandler() {
        return (request, response, accessDeniedException) -> {
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();

            if (auth != null && auth.isAuthenticated()) {
                Object principal = auth.getPrincipal();
                if (principal instanceof CustomOAuth2User customUser) {
                    if (customUser.getRole() == Role.TEMP) {
                        response.sendRedirect("/admin/profile?error=need_profile");
                        return;
                    }
                }
            }

            response.sendRedirect("/error/403"); // Í∏∞Î≥∏ 403 Ï≤òÎ¶¨
        };
    }
}