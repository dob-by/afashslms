<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::body})}">
<head>
    <meta charset="UTF-8">
    <title>ìˆ˜ë¦¬ ìš”ì²­ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<main class="container my-5">
    <h3 class="mb-4 text-center fw-semibold">ìˆ˜ë¦¬ ìš”ì²­ ìƒì„¸</h3>

    <div class="card p-4 shadow">
        <dl class="row">
            <dt class="col-sm-3">í•™ìƒ ì´ë¦„</dt>
            <dd class="col-sm-9" th:text="${repair.user.username}">í™ê¸¸ë™</dd>

            <dt class="col-sm-3">ì´ë©”ì¼</dt>
            <dd class="col-sm-9" th:text="${repair.user.email}">student@example.com</dd>

            <dt class="col-sm-3">ì¼ë ¨ë²ˆí˜¸</dt>
            <dd class="col-sm-9" th:text="${repair.deviceSerial}">SN-000123</dd>

            <dt class="col-sm-3">ë¬¸ì œ ìœ í˜•</dt>
            <dd class="col-sm-9" th:text="${repair.category}">HW</dd>

            <dt class="col-sm-3">ì„¸ë¶€ ë¬¸ì œ</dt>
            <dd class="col-sm-9" th:text="${repair.detailType}">ë¶€íŒ… ë¶ˆê°€</dd>

            <dt class="col-sm-3">ìƒì„¸ ë‚´ìš©</dt>
            <dd class="col-sm-9" th:text="${repair.description}">ì „ì›ì´ ì•ˆ ì¼œì ¸ìš”</dd>

            <dt class="col-sm-3">ë‹´ë‹¹ì</dt>
            <dd class="col-sm-9" th:text="${repair.manager}">ê¹€í•˜ëŠ˜</dd>

            <th:block th:if="${userRole != null and (userRole.contains('MID_ADMIN') or userRole.contains('TOP_ADMIN'))}">
                <dt class="col-sm-3">CMOS ë¹„ë°€ë²ˆí˜¸</dt>
                <dd class="col-sm-9"
                    th:text="${#strings.isEmpty(repair.cmosPassword) ? 'ì…ë ¥ ì•ˆë¨' : repair.cmosPassword}">1234</dd>

                <dt class="col-sm-3">Windows ë¹„ë°€ë²ˆí˜¸</dt>
                <dd class="col-sm-9"
                    th:text="${#strings.isEmpty(repair.windowsPassword) ? 'ì…ë ¥ ì•ˆë¨' : repair.windowsPassword}">abcd</dd>
            </th:block>
            <!-- ìƒíƒœ -->
            <dt class="col-sm-3 fw-bold">ìƒíƒœ</dt>
            <dd class="col-sm-9" th:text="${repair.status.displayName}">ìˆ˜ë¦¬ ìš”ì²­ë¨</dd>

            <!-- ë°˜ë ¤ ì‚¬ìœ  (í•œ ì¤„ ìˆ˜í‰ ì •ë ¬) -->
            <dt class="col-sm-3 fw-bold text-danger" th:if="${repair.status.name() == 'REJECTED'}">ë°˜ë ¤ ì‚¬ìœ </dt>
            <dd class="col-sm-9 text-danger" th:if="${repair.status.name() == 'REJECTED'}" th:text="${repair.rejectionReason}">ìš”ì²­ ë‚´ìš©ì´ ë¶ˆì¶©ë¶„í•©ë‹ˆë‹¤.</dd>
        </dl>

        <form th:action="@{'/admin/repairs/' + ${repair.id} + '/status'}" method="post">
            <!-- ìƒíƒœ ë³€ê²½ ì˜ì—­ -->
            <div th:if="${userRole == 'TOP_ADMIN'}">
                <form th:action="@{'/admin/repairs/' + ${repair.id} + '/status'}" method="post" id="topAdminForm">
                    <div class="mb-3">
                        <label for="status" class="form-label">ìˆ˜ë¦¬ ìƒíƒœ ë³€ê²½</label>
                        <select id="status" name="status" class="form-select" onchange="toggleRejectionReason()">
                            <option th:each="s : ${statuses}"
                                    th:value="${s}"
                                    th:text="${s.displayName}"
                                    th:selected="${s} == ${repair.status}">
                            </option>
                        </select>
                    </div>

                    <!-- ğŸ”½ ìƒíƒœê°€ REJECTEDì¼ ë•Œë§Œ ë°˜ë ¤ ì‚¬ìœ  ì…ë ¥ë€ ë³´ì—¬ì¤Œ -->
                    <div id="rejectionReasonBox" class="mb-3 d-none">
                        <label for="rejectionReason" class="form-label">ë°˜ë ¤ ì‚¬ìœ </label>
                        <textarea id="rejectionReason" name="rejectionReason" class="form-control" rows="3"
                                  placeholder="ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (REJECTED ì„ íƒ ì‹œ í•„ìˆ˜)"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">ìƒíƒœ ì—…ë°ì´íŠ¸</button>
                </form>
            </div>

            <div th:if="${userRole == 'MID_ADMIN'}">
                <div th:if="${repair.status.name() == 'REQUESTED'}">
                    <form th:action="@{'/admin/repairs/' + ${repair.id} + '/status'}" method="post">
                        <input type="hidden" name="status" value="IN_PROGRESS" />
                        <button type="submit" class="btn btn-warning">ìŠ¹ì¸</button>
                    </form>
                    <!-- ë°˜ë ¤ ë²„íŠ¼ (ì¤‘ê°„ ê´€ë¦¬ììš©) -->
                    <div th:if="${userRole == 'MID_ADMIN' and repair.status.name() == 'REQUESTED'}" class="mt-3">
                        <form th:action="@{'/admin/repairs/' + ${repair.id} + '/reject'}" method="post">
                            <div class="mb-2">
                                <label for="rejectionReason" class="form-label">ë°˜ë ¤ ì‚¬ìœ </label>
                                <textarea id="rejectionReasonMid" name="rejectionReason" class="form-control" rows="3" placeholder="ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger">ë°˜ë ¤</button>
                        </form>
                    </div>
                </div>
                <div th:if="${repair.status.name() == 'IN_PROGRESS'}">
                    <form th:action="@{'/admin/repairs/' + ${repair.id} + '/status'}" method="post">
                        <input type="hidden" name="status" value="COMPLETED" />
                        <button type="submit" class="btn btn-success">ìˆ˜ë¦¬ ì™„ë£Œ</button>
                    </form>
                </div>
            </div>
        </form>
    </div>
    <!-- ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ -->
    <div class="mt-4 text-center">
        <a th:if="${userRole == 'STUDENT'}" th:href="@{/repairs}" class="btn btn-secondary">ğŸ”™ ëª©ë¡ìœ¼ë¡œ</a>
        <a th:if="${userRole == 'MID_ADMIN' or userRole == 'TOP_ADMIN'}" th:href="@{/admin/repairs}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
    </div>
</main>
<script>
    function toggleRejectionReason() {
        const status = document.getElementById("status").value;
        const rejectionBox = document.getElementById("rejectionReasonBox");
        if (status === "REJECTED") {
            rejectionBox.classList.remove("d-none");
        } else {
            rejectionBox.classList.add("d-none");
        }
    }

    // í˜ì´ì§€ ì§„ì… ì‹œ ì´ˆê¸° ì²´í¬ (ì´ë¯¸ REJECTEDì¼ ê²½ìš° ë³´ì—¬ì¤˜ì•¼ í•˜ë‹ˆê¹Œ!)
    document.addEventListener("DOMContentLoaded", function () {
        toggleRejectionReason();
    });
</script>
</body>
</html>
